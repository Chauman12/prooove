<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profundización de Habilidades</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- ================== CSS ================== -->
    <style>
        :root {
            --primary-blue: #007aff;
            --primary-green: #34c759;
            --primary-red: #ff3b30;
            --light-gray: #f0f2f5;
            --border-color: #dcdcdc;
            --text-color: #1c1c1e;
            --line-color: #555;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-gray);
            color: var(--text-color);
            overflow: hidden;
        }

        header {
            background-color: #ffffff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            z-index: 20;
            position: relative;
        }

        header h1 { margin: 0; font-size: 1.75rem; color: #000; }
        header p { margin: 0.25rem 0 0; color: #6c757d; }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 160px); 
            background-color: #f5f5f5;
            overflow: hidden;
            cursor: grab;
        }
        #canvas-container:active { cursor: grabbing; }
        
        #viewport {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #fafafa 20px, transparent 1%) center, linear-gradient(#fafafa 20px, transparent 1%) center;
            background-size: 22px 22px;
            transform-origin: 0 0;
        }
        
        #svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .connection-line {
            stroke: var(--line-color);
            stroke-width: 2px;
            transition: stroke 0.2s;
        }
        
        #arrowhead {
            fill: var(--line-color);
        }

        .node {
            position: absolute;
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background-color: #ffffff;
            border: 3px solid #ccc;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; padding: 10px;
            box-sizing: border-box; cursor: grab;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, outline 0.2s ease;
            user-select: none;
            outline: 3px solid transparent; /* Para la animación de error */
        }
        
        .node.is-dragging { cursor: grabbing; transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.15); z-index: 10; }
        .node.selected-for-connection { border-color: var(--primary-blue); box-shadow: 0 0 15px rgba(0, 122, 255, 0.5); }

        .node-image, .node-image-placeholder, .node-icon { 
            width: 50px; height: 50px;
            margin-bottom: 8px; 
            pointer-events: none; 
        }
        
        .node-icon {
            font-size: 40px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .node-image, .node-image-placeholder {
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid rgba(0,0,0,0.05);
        }

        .node-image-placeholder { background: #e9ecef; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #6c757d; }

        .node-label { font-size: 14px; font-weight: 600; pointer-events: none; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .node.subskill { background-color: #d1e7dd; border-color: #a3cfbb; }
        .node.secondary-skill { background-color: #cff4fc; border-color: #9eeaf9; }
        .node.fixed-skill { background-color: #fff3cd; border-color: #ffe69c; width: 140px; height: 140px; }
        .node.fixed-skill .node-label { font-size: 16px; }

        #controls {
            padding: 1rem; background-color: #ffffff;
            text-align: center; display: flex; justify-content: center;
            gap: 1rem; border-top: 1px solid var(--border-color);
            position: relative; z-index: 20;
        }

        #controls button { padding: 12px 25px; font-size: 16px; font-weight: 500; cursor: pointer; border: none; color: white; border-radius: 8px; transition: background-color 0.2s, transform 0.1s; }
        #add-subskill-btn { background-color: var(--primary-green); }
        #add-subskill-btn:hover { background-color: #2ca349; }
        #add-secondary-skill-btn { background-color: var(--primary-blue); }
        #add-secondary-skill-btn:hover { background-color: #0056b3; }
        #controls button:active { transform: scale(0.98); }
        #controls button:disabled { background-color: #aeb0b3; cursor: not-allowed; }

        #controls input[type="file"] { display: none; }

        /* Modal Styling */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; text-align: left; max-height: 90vh; overflow-y: auto; }
        .modal-content h2 { margin-top: 0; }
        .modal-content input { width: 100%; padding: 10px; margin-top: 1rem; margin-bottom: 1.5rem; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; box-sizing: border-box; }
        
        #category-info-modal .modal-content h3 { margin-top: 1.5rem; margin-bottom: 0.5rem; }
        #category-info-modal .modal-content ul { padding-left: 20px; margin: 0; }
        #category-info-modal .modal-content li { margin-bottom: 0.5rem; }

        #icon-selector { margin-top: 1rem; display: none; }
        #icon-selector h3 { margin: 0 0 0.5rem 0; font-size: 1rem; color: #6c757d; text-align: left; }
        .icon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        .icon-option { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 20px; }
        .icon-option:hover { background-color: #f0f0f0; }
        .icon-option.selected { border-color: var(--primary-blue); background-color: #e6f2ff; }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem; }
        .modal-buttons button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: 500;}
        .modal-close-btn { background: #e5e5ea; }
        #modal-confirm { background: var(--primary-blue); color: white; }

    </style>
</head>
<body>

    <header>
        <h1>Mapa de Profundización</h1>
        <p>Un clic para conectar. Doble clic en nodo para acción especial.</p>
    </header>

    <div id="controls">
        <input type="file" id="image-upload-input" accept="image/*">
        <button id="add-subskill-btn">Agregar Sub-Habilidad Principal</button>
        <button id="add-secondary-skill-btn">Agregar Habilidad Secundaria</button>
    </div>
    
    <div id="canvas-container">
        <div id="viewport">
            <svg id="svg-layer">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                    refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" style="fill: var(--line-color);" />
                    </marker>
                </defs>
            </svg>
        </div>
    </div>
    
    <div id="node-name-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <input type="text" id="modal-input" placeholder="Escribe aquí...">
            <div id="icon-selector">
                <h3>Elige un Ícono</h3>
                <div class="icon-grid"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-close-btn">Cancelar</button>
                <button id="modal-confirm">Crear</button>
            </div>
        </div>
    </div>
    
    <!-- New Modal for Category Info -->
    <div id="category-info-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="category-modal-title"></h2>
            <p id="category-modal-desc"></p>
            <h3 id="category-modal-training-title"></h3>
            <ul id="category-modal-training-list"></ul>
            <div class="modal-buttons">
                 <button class="modal-close-btn">Cerrar</button>
            </div>
        </div>
    </div>


    <!-- ================== JAVASCRIPT ================== -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('canvas-container');
        const viewport = document.getElementById('viewport');
        const svgLayer = document.getElementById('svg-layer');
        const addSubskillBtn = document.getElementById('add-subskill-btn');
        const addSecondarySkillBtn = document.getElementById('add-secondary-skill-btn');
        const imageUploadInput = document.getElementById('image-upload-input');
        
        const nodeNameModal = document.getElementById('node-name-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalInput = document.getElementById('modal-input');
        const modalConfirm = document.getElementById('modal-confirm');
        const iconSelector = document.getElementById('icon-selector');
        const iconGrid = document.querySelector('.icon-grid');
        let modalResolve = null;

        const categoryInfoModal = document.getElementById('category-info-modal');
        const categoryModalTitle = document.getElementById('category-modal-title');
        const categoryModalDesc = document.getElementById('category-modal-desc');
        const categoryModalTrainingTitle = document.getElementById('category-modal-training-title');
        const categoryModalTrainingList = document.getElementById('category-modal-training-list');

        let nodes = new Map();
        let connections = new Set();
        let selectedNodeForImage = null;
        let mainSubSkillNode = null;
        let isConnecting = false, connectionStartNode = null, tempLine = null;
        
        let pan = { x: 0, y: 0 }, zoom = 1;

        const ICONS = [
            'fa-solid fa-brain', 'fa-solid fa-lightbulb', 'fa-solid fa-crosshairs', 'fa-solid fa-person-running',
            'fa-solid fa-shield-halved', 'fa-solid fa-puzzle-piece', 'fa-solid fa-timeline', 'fa-solid fa-comments',
            'fa-solid fa-magnifying-glass', 'fa-solid fa-seedling', 'fa-solid fa-trophy', 'fa-solid fa-book-open',
            'fa-solid fa-gears', 'fa-solid fa-chart-line', 'fa-solid fa-hand-fist', 'fa-solid fa-key',
            'fa-solid fa-link', 'fa-solid fa-sitemap', 'fa-solid fa-pen-ruler', 'fa-solid fa-bullseye',
            'fa-solid fa-handshake-angle', 'fa-solid fa-hourglass-half', 'fa-solid fa-bolt', 'fa-solid fa-scale-balanced'
        ];

        const CATEGORY_CONTENT = {
            'Planificación': {
                title: 'Funciones Ejecutivas (FE)',
                description: 'Las funciones ejecutivas son el director de orquesta de tu mente. Coordina la planificación, la flexibilidad y la toma de decisiones, permitiéndote alcanzar objetivos incluso en situaciones imprevistas.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Planifica con juego: Diseña el menú de la semana o crea una ruta del tesoro en el supermercado.',
                        'Desafíos cotidianos: Organiza pequeños proyectos o retos diarios que involucren selección de estrategias, control de impulsos y autorregulación.'
                    ],
                    conclusion: 'Con estas actividades, conviertes la rutina en una aventura de superpoderes mentales.'
                }
            },
            'Enfoque': {
                title: 'Atención',
                description: 'La atención es ese flash que te permite centrarte en lo esencial en medio del bullicio diario. Con el tiempo, mantener el enfoque puede ser un desafío, pero es posible entrenarlo de forma divertida.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Explora tu entorno: Durante un paseo, desafíate a identificar detalles: colores, sonidos o texturas.',
                        'Juego sensorial: Alterna tareas para captar pistas visuales y auditivas en entornos naturales en lugar de depender solo de instrucciones verbales.'
                    ],
                    conclusion: 'De esta manera, transformarás una simple caminata en una experiencia sensorial inolvidable.'
                }
            },
            'Análisis': {
                title: 'Memoria de Trabajo',
                description: 'Tu memoria de trabajo es como la mesa de un chef, donde se mantienen los ingredientes necesarios para preparar una buena receta mental.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Matemáticas con sabor: Practica cálculos mentales usando caramelos o monedas como “ingredientes”.',
                        'Recetas y retos: Al cocinar, desafíate a recordar y combinar ingredientes de forma creativa, estimulando la retención y manipulación de información.'
                    ],
                    conclusion: 'Así, cada tarea diaria se convierte en un juego de organización y creatividad.'
                }
            },
            'Disciplina': {
                title: 'Control Inhibitorio',
                description: 'Este es el freno que impide que los impulsos tomen el control, permitiéndote actuar con mesura y claridad.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Desafío del autocontrol: Cuando sientas la tentación de actuar impulsivamente (como revisar el móvil de inmediato), tómate un instante para respirar y pensar.',
                        'Pequeños juegos: Practica detener respuestas automáticas en situaciones cotidianas, fortaleciendo esa capacidad para reflexionar antes de actuar.'
                    ],
                    conclusion: 'Practicar el control inhibitorio te ayudará a mantener la calma en medio del caos.'
                }
            },
            'Adaptabilidad': {
                title: 'Flexibilidad Cognitiva',
                description: 'La flexibilidad cognitiva es tu capacidad para adaptarte a nuevas situaciones y cambiar de estrategia cuando es necesario.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Rutas alternativas: Cambia de camino al trabajo o intenta una actividad inesperada en tu rutina diaria.',
                        'Desafíos contextuales: Enfrenta pequeños retos, como improvisar soluciones creativas en situaciones cotidianas (subir una rampa o sortear un bordillo), y descubre nuevas formas de ver el mundo.'
                    ],
                    conclusion: 'Cada variación en la rutina es una oportunidad para ejercitar tu mente y hacerlo con diversión.'
                }
            },
             'Creatividad': {
                title: 'Lágrimas y Sudor (Plasticidad Cerebral)',
                description: 'Este concepto celebra la capacidad del cerebro para remodelarse y aprender continuamente a partir de experiencias ricas y significativas.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Explora y crea: Sumérgete en actividades artísticas, baila al ritmo de una nueva melodía o aprende algo totalmente distinto de lo habitual.',
                        'Vive plenamente: Busca experiencias auténticas que despierten emociones: cada risa, cada desafío y cada logro potencian las conexiones neuronales.'
                    ],
                    conclusion: 'Tras cada experiencia, tu cerebro se refresca, listo para aprender algo nuevo.'
                }
            },
            'Resiliencia': {
                title: 'Metacognición y Autorregulación del Aprendizaje',
                description: 'Esta habilidad te invita a ser el director de tu propio aprendizaje, aprendiendo a reconocer y mejorar tus propios procesos mentales.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Diario mental: Reflexiona sobre tus métodos, identifica qué te ayuda y qué no, y rediseña tus estrategias de aprendizaje de forma creativa.',
                        'Auto-retroalimentación: Celebra cada pequeño avance y ajusta tus desafíos diarios para que aprender sea un proceso dinámico y personal.'
                    ],
                    conclusion: 'Transforma cada día en un laboratorio de autodescubrimiento y crecimiento.'
                }
            },
            'Comunicación': {
                title: 'Habilidades Socio-Emocionales (Empatía y Regulación Emocional)',
                description: 'Estas habilidades son las claves para conectar de manera auténtica con los demás, gestionando tus emociones e interpretando las de los que te rodean.',
                training: {
                    title: 'Entrenamiento Lúdico',
                    points: [
                        'Juego del espejo: Observa y reflexiona sobre tus reacciones en conversaciones cotidianas. Practica desde dar un “gracias” sincero y pedir disculpas, hasta resolver malentendidos de forma asertiva.',
                        'Reto emocional: Incrementa gradualmente la complejidad de las interacciones sociales, pasando de situaciones básicas a escenarios más desafiantes, mejorando así tu inteligencia emocional.'
                    ],
                    conclusion: 'Al entrenar estas habilidades, cada interacción se convierte en un juego de empatía y autoconciencia.'
                }
            }
        };
        
        function updateView() { viewport.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`; }
        function screenToWorld({ x, y }) {
            const canvasRect = canvas.getBoundingClientRect();
            return {
                x: (x - canvasRect.left - pan.x) / zoom,
                y: (y - canvasRect.top - pan.y) / zoom
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (e.target === canvas || e.target === viewport) {
                let isPanning = true;
                const panStart = { x: e.clientX - pan.x, y: e.clientY - pan.y };
                canvas.style.cursor = 'grabbing';
                
                function onMouseMove(moveEvent) {
                    if (isPanning) {
                       pan.x = moveEvent.clientX - panStart.x;
                       pan.y = moveEvent.clientY - panStart.y;
                       updateView();
                    }
                }
                
                function onMouseUp() {
                    isPanning = false;
                    canvas.style.cursor = 'grab';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
                
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
        });
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const minZoom = 0.2, maxZoom = 2.5;
            const worldPos = screenToWorld({ x: e.clientX, y: e.clientY });
            const zoomFactor = -e.deltaY * 0.001;
            const newZoom = Math.max(minZoom, Math.min(maxZoom, zoom + zoomFactor));
            pan.x += worldPos.x * (zoom - newZoom);
            pan.y += worldPos.y * (zoom - newZoom);
            zoom = newZoom;
            updateView();
        });
        canvas.addEventListener('click', (e) => {
             if ((e.target === canvas || e.target === viewport) && isConnecting) {
                cancelConnection();
            }
        });

        function getCenter(nodeElement) { return { x: nodeElement.offsetLeft + nodeElement.offsetWidth / 2, y: nodeElement.offsetTop + nodeElement.offsetHeight / 2 }; }
        function getNodeType(nodeElement) {
            if (nodeElement.classList.contains('subskill')) return 'subskill';
            if (nodeElement.classList.contains('secondary-skill')) return 'secondary-skill';
            if (nodeElement.classList.contains('fixed-skill')) return 'fixed-skill';
            return null;
        }
        
        function startConnectionMode(nodeElement) {
            isConnecting = true;
            connectionStartNode = nodeElement;
            connectionStartNode.classList.add('selected-for-connection');
            const startPos = getCenter(connectionStartNode);
            tempLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            tempLine.setAttribute('x1', startPos.x); tempLine.setAttribute('y1', startPos.y);
            tempLine.setAttribute('x2', startPos.x); tempLine.setAttribute('y2', startPos.y);
            tempLine.setAttribute('class', 'connection-line');
            tempLine.style.strokeDasharray = '5, 5';
            tempLine.setAttribute('marker-end', 'url(#arrowhead)');
            svgLayer.appendChild(tempLine);
            viewport.addEventListener('mousemove', followCursorWithTransform);
        }
        
        function connectNodes(startNode, endNode) {
            const startType = getNodeType(startNode);
            const endType = getNodeType(endNode);
            const isValid = (startType === 'subskill' && endType === 'secondary-skill') || (startType === 'fixed-skill' && endType === 'secondary-skill');
            
            if (!isValid || endNode === startNode) {
                if (isConnecting && tempLine) {
                    tempLine.style.stroke = 'var(--primary-red)';
                    setTimeout(() => cancelConnection(), 300);
                }
                return;
            }
            
            const fromId = startNode.id, toId = endNode.id;
            if (connections.has(`${fromId}-${toId}`) || connections.has(`${toId}-${fromId}`)) {
                cancelConnection();
                return;
            }
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('class', 'connection-line');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            
            updateLinePosition(line, startNode, endNode);
            svgLayer.appendChild(line);

            const connInfo = { from: fromId, to: toId, line: line };
            nodes.get(fromId).connections.push(connInfo);
            nodes.get(toId).connections.push(connInfo);
            connections.add(`${fromId}-${toId}`);
            
            if (isConnecting) cancelConnection();
        }
        
        function updateLinePosition(line, startNode, endNode) {
             const startPos = getCenter(startNode);
             const endPos = getCenter(endNode);
             line.setAttribute('x1', startPos.x);
             line.setAttribute('y1', startPos.y);
             line.setAttribute('x2', endPos.x);
             line.setAttribute('y2', endPos.y);
        }

        function cancelConnection() {
            isConnecting = false;
            if (connectionStartNode) connectionStartNode.classList.remove('selected-for-connection');
            connectionStartNode = null;
            if (tempLine) tempLine.remove();
            tempLine = null;
            viewport.removeEventListener('mousemove', followCursorWithTransform);
        }

        function followCursorWithTransform(e) {
            if (!isConnecting || !tempLine) return;
            const worldPos = screenToWorld({ x: e.clientX, y: e.clientY });
            tempLine.setAttribute('x2', worldPos.x);
            tempLine.setAttribute('y2', worldPos.y);
        }

        function updateConnectionsForNode(nodeElement) {
            const nodeInfo = nodes.get(nodeElement.id);
            if (!nodeInfo) return;
            nodeInfo.connections.forEach(conn => {
                const startNode = nodes.get(conn.from).element;
                const endNode = nodes.get(conn.to).element;
                updateLinePosition(conn.line, startNode, endNode);
            });
        }
        
        function createNode(type, {label, iconClass = ''}, x, y) {
            const nodeElement = document.createElement('div');
            nodeElement.className = `node ${type}`;
            nodeElement.style.left = `${x}px`;
            nodeElement.style.top = `${y}px`;
            nodeElement.id = `node-${Date.now()}`;
            
            let contentHtml = '';
            if (type === 'subskill') {
                contentHtml = `<div class="node-image-placeholder">Subir foto</div>`;
            } else if (type === 'secondary-skill') {
                contentHtml = `<div class="node-icon"><i class="${iconClass}"></i></div>`;
            }

            nodeElement.innerHTML = `${contentHtml}<span class="node-label">${label}</span>`;
            
            let wasDragging = false;
            
            nodeElement.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                wasDragging = false;
                const dragThreshold = 5;
                const startPos = { x: e.clientX, y: e.clientY };
                const initialNodePos = { left: nodeElement.offsetLeft, top: nodeElement.offsetTop };

                function onMouseMove(moveEvent) {
                    const dx = moveEvent.clientX - startPos.x;
                    const dy = moveEvent.clientY - startPos.y;
                    if (!wasDragging && (Math.abs(dx) > dragThreshold || Math.abs(dy) > dragThreshold)) {
                        wasDragging = true;
                        nodeElement.classList.add('is-dragging');
                    }
                    if (wasDragging) {
                        const newX = initialNodePos.left + dx / zoom;
                        const newY = initialNodePos.top + dy / zoom;
                        nodeElement.style.left = `${newX}px`;
                        nodeElement.style.top = `${newY}px`;
                        updateConnectionsForNode(nodeElement);
                    }
                }
                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    nodeElement.classList.remove('is-dragging');
                }
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp, { once: true });
            });

            nodeElement.addEventListener('click', (e) => {
                 e.stopPropagation();
                 setTimeout(() => {
                    if (wasDragging) return;
                    if (!isConnecting) {
                        const startType = getNodeType(nodeElement);
                        if (startType === 'secondary-skill') {
                            flashNodeError(nodeElement);
                            return;
                        }
                        startConnectionMode(nodeElement);
                    } else { 
                        connectNodes(connectionStartNode, nodeElement);
                    }
                 }, 50);
            });

            nodeElement.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                const nodeType = getNodeType(nodeElement);
                if (nodeType === 'subskill') {
                    selectedNodeForImage = nodeElement;
                    imageUploadInput.click();
                } else if (nodeType === 'fixed-skill') {
                    showCategoryInfo(label);
                }
            });

            viewport.appendChild(nodeElement);
            nodes.set(nodeElement.id, { element: nodeElement, connections: [] });
            return nodeElement;
        }
        
        function askNodeDetails(title, placeholder, showIcons = false) {
            modalTitle.textContent = title;
            modalInput.placeholder = placeholder;
            modalInput.value = '';
            iconGrid.innerHTML = '';
            
            let selectedIconClass = '';

            if (showIcons) {
                iconSelector.style.display = 'block';
                ICONS.forEach(icon => {
                    const iconOption = document.createElement('div');
                    iconOption.className = 'icon-option';
                    iconOption.innerHTML = `<i class="${icon}"></i>`;
                    iconOption.dataset.icon = icon;
                    iconGrid.appendChild(iconOption);
                    
                    iconOption.addEventListener('click', () => {
                        document.querySelectorAll('.icon-option.selected').forEach(el => el.classList.remove('selected'));
                        iconOption.classList.add('selected');
                        selectedIconClass = icon;
                    });
                });
            } else {
                iconSelector.style.display = 'none';
            }
            
            nodeNameModal.style.display = 'flex';
            modalInput.focus();
            
            return new Promise(resolve => { 
                modalResolve = (confirmed) => {
                    if (confirmed && modalInput.value.trim()) {
                        resolve({ label: modalInput.value.trim(), iconClass: selectedIconClass });
                    } else {
                        resolve(null);
                    }
                };
            });
        }
        
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.modal-overlay').style.display = 'none';
                if (btn.closest('.modal-overlay') === nodeNameModal && modalResolve) {
                    modalResolve(false);
                }
            });
        });
        
        modalConfirm.addEventListener('click', () => { nodeNameModal.style.display = 'none'; if(modalResolve) modalResolve(true); });

        function showCategoryInfo(categoryName) {
            const content = CATEGORY_CONTENT[categoryName];
            if (!content) return;
            
            categoryModalTitle.textContent = content.title;
            categoryModalDesc.textContent = content.description;
            categoryModalTrainingTitle.textContent = content.training.title;
            
            categoryModalTrainingList.innerHTML = '';
            content.training.points.forEach(point => {
                const li = document.createElement('li');
                li.textContent = point;
                categoryModalTrainingList.appendChild(li);
            });
            const conclusionLi = document.createElement('li');
            conclusionLi.innerHTML = `<strong>${content.training.conclusion}</strong>`;
            conclusionLi.style.listStyle = 'none';
            conclusionLi.style.marginTop = '1rem';
            categoryModalTrainingList.appendChild(conclusionLi);

            categoryInfoModal.style.display = 'flex';
        }

        addSubskillBtn.addEventListener('click', async () => {
            const details = await askNodeDetails("Añadir Sub-Habilidad Principal", "Ej: Ajedrez");
            if (details) {
                const worldCenter = screenToWorld({x: canvas.clientWidth/2, y: canvas.clientHeight/2});
                const newNode = createNode('subskill', details, worldCenter.x - 65, worldCenter.y - 65);
                mainSubSkillNode = newNode;
                addSubskillBtn.disabled = true;
            }
        });

        addSecondarySkillBtn.addEventListener('click', async () => {
            if (!mainSubSkillNode) {
                alert("Por favor, primero agrega una Sub-Habilidad Principal.");
                return;
            }
            const details = await askNodeDetails("Añadir Habilidad Secundaria", "Ej: Concentración", true);
            if (details) {
                const worldCenter = screenToWorld({x: canvas.clientWidth/2, y: canvas.clientHeight/2});
                const newNode = createNode('secondary-skill', details, worldCenter.x - 65, worldCenter.y);
                connectNodes(mainSubSkillNode, newNode);
            }
        });
        
        imageUploadInput.addEventListener('change', (event) => {
            if (!event.target.files || !event.target.files[0] || !selectedNodeForImage) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let imageContainer = selectedNodeForImage.querySelector('.node-image-placeholder, .node-image');
                if (imageContainer.classList.contains('node-image-placeholder')) {
                    const newImg = document.createElement('img'); newImg.classList.add('node-image');
                    imageContainer.replaceWith(newImg); newImg.src = e.target.result;
                } else { imageContainer.src = e.target.result; }
                imageUploadInput.value = '';
            };
            reader.readAsDataURL(event.target.files[0]);
        });
        
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') cancelConnection(); });
        
        function initializeFixedNodes() {
            const fixedData = [
                'Enfoque', 'Disciplina', 'Creatividad', 'Resiliencia', 
                'Comunicación', 'Planificación', 'Análisis', 'Adaptabilidad'
            ];
             const positions = [
                { x: 200, y: 100 }, { x: 1000, y: 100 },
                { x: 200, y: 800 }, { x: 1000, y: 800 },
                { x: 600, y: 50 }, { x: 600, y: 850 },
                { x: 100, y: 450 }, { x: 1100, y: 450 }
            ];
            fixedData.forEach((name, i) => {
                createNode('fixed-skill', {label: name}, positions[i].x, positions[i].y);
            });
        }
        
        initializeFixedNodes();
        updateView();
    });
    </script>
</body>
</html>
